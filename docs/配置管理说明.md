# ThreatSync 配置管理说明

## 配置文件优先级

ThreatSync 配置管理系统按以下优先级加载配置文件：

1. **config.local.yaml** (最高优先级) - 本地配置文件，包含真实的API密钥和个人配置
2. **config.example.yaml** (中等优先级) - 示例配置文件，用作默认配置模板
3. **config.yaml** (向后兼容) - 旧版本配置文件，仅为兼容性保留
4. **默认配置** (最低优先级) - 硬编码的默认配置，当所有配置文件都不存在时使用

## 配置文件结构

所有API的基础URL都在配置文件中定义，不再使用硬编码：

### 基本API配置

```yaml
apis:
  # GitHub API配置
  github:
    token: "your_github_token_here"
    rate_limit: 5000
    base_url: "https://api.github.com"  # GitHub API基础URL
    collection:
      default_method: "rest"
      supported_methods: ["rest", "graphql", "database"]
      methods:
        rest:
          per_page: 100
          max_pages: 100
        graphql:
          per_page: 100
          max_pages: 50
        database:
          repo_url: "https://github.com/github/advisory-database.git"  # Advisory Database仓库URL
          clone_timeout: 300
          shallow_clone: true

  # NVD API配置
  nvd:
    api_key: "your_nvd_api_key_here"
    base_url: "https://services.nvd.nist.gov/rest/json/cves/2.0"  # NVD API基础URL
    rate_limit:
      requests_per_30s: 50
      sleep_between_requests: 6
    pagination:
      results_per_page: 2000
      max_total_results: 50000

  # OSV API配置
  osv:
    base_url: "https://api.osv.dev/v1"  # OSV API基础URL
```

## 从配置文件读取API URL

### GitHub采集器

GitHub采集器现在从配置文件中读取以下URL：

- **REST API URL**: `{base_url}/advisories`
- **GraphQL API URL**: `{base_url}/graphql`
- **Advisory Database仓库URL**: 从 `apis.github.collection.methods.database.repo_url` 配置项读取

### NVD采集器

- **API URL**: 从 `apis.nvd.base_url` 配置项读取

### OSV采集器

- **API URL**: 从 `apis.osv.base_url` 配置项读取

## 环境变量覆盖

系统支持使用环境变量覆盖配置文件中的敏感信息：

```bash
# GitHub Token
export GITHUB_TOKEN="your_github_token"

# NVD API Key
export NVD_API_KEY="your_nvd_api_key"
```

环境变量的优先级高于配置文件。

## 配置管理器使用示例

```python
from ThreatSync.utils.config import ConfigManager

# 创建配置管理器实例
config = ConfigManager()

# 获取GitHub配置
github_config = config.get_api_config('github')
base_url = github_config.get('base_url')
token = github_config.get('token')

# 获取NVD配置
nvd_config = config.get_api_config('nvd')
nvd_url = nvd_config.get('base_url')
api_key = nvd_config.get('api_key')

# 获取OSV配置
osv_config = config.get_api_config('osv')
osv_url = osv_config.get('base_url')
```

## 配置验证

运行以下命令验证配置是否正确加载：

```bash
python -c "
from ThreatSync.utils.config import ConfigManager
config = ConfigManager()
print('GitHub Base URL:', config.get_api_config('github').get('base_url'))
print('NVD Base URL:', config.get_api_config('nvd').get('base_url'))
print('OSV Base URL:', config.get_api_config('osv').get('base_url'))
"
```

## 最佳实践

1. **使用本地配置文件**：始终将真实的API密钥保存在 `config.local.yaml` 中
2. **保护敏感信息**：将 `config.local.yaml` 添加到 `.gitignore` 中，避免提交到版本控制
3. **使用示例配置**：使用 `config.example.yaml` 作为配置模板
4. **环境变量**：在生产环境中使用环境变量管理敏感配置
5. **配置验证**：定期验证配置文件格式和内容的正确性

## 故障排除

### 配置文件未找到
- 确保 `config.local.yaml` 或 `config.example.yaml` 存在于 `config/` 目录中
- 检查文件权限和编码格式（应为UTF-8）

### YAML解析错误
- 验证YAML文件格式是否正确
- 检查缩进是否一致（使用空格，不要使用制表符）
- 确保字符串值被正确引用

### API URL配置错误
- 确保 `base_url` 配置项存在且格式正确
- 验证URL是否可访问
- 检查网络连接和代理设置

## 配置文件示例

完整的配置文件示例请参考：
- `config/config.local.yaml` - 实际使用的配置文件
- `config/config.example.yaml` - 配置模板文件
